# Lec 3 灰度变换与空间滤波

图像增强

- 定义：图像增强是指按特定的需要突出一幅图像中的某些信息， 同时消弱或去除某些不需要的信息的处理方法

  > 图像增强处理最大的困难：增强后图像质量的好坏主要依靠人的主观视觉来评定，也就是说，难以定量描述

- 应用：图像的动态范围得到压缩、 图像边缘信息得到锐化处理以及解决颜色恒常性(即改变光照变化的影响)

空间域基本概念：

- 空间域：所有像素点组成的总和。
- 空间域图像处理主要两类：灰度变换和空间滤波
- 邻域：4/8邻域
- 邻接：4邻接，8邻接，m邻接（用于消除8邻接的二义性，各自邻域无相交）

## 灰度变换*

灰度变换：可调整图像的动态范围或图像对比度， 是图像增强重要手段之一 
$$
s=T(r)
$$

两个应用：对比度处理和阈值处理。下面给出一些基本的灰度变换函数：

- 图像反转
  $$
  s=L-1-r,灰度级区间[0,L-1]
  $$
  图像反转可用于**增强图像暗色区域中的白色或灰色细节**， 暗色区域的尺寸很大时这种增强效果更好

- 对数变换
  $$
  s=c\log(1+r),\text{assume} ~~ r\gg 0,c ~is ~a~constant
  $$
  **将输入中范围较窄的低灰度值映射为输出中范围较宽的灰度级**

  扩展图像中的暗像素值， 同时压缩高灰度级值。 反对数（指数） 变换的功能正好相反

  ![image-20250609233817884](E:\notes_in_zju\docs\notes\cs\assets\数字图像处理Lec1_7.assets\image-20250609233817884.png)

- 幂律（伽马）变换  
  $$
  s = cr^\gamma
  $$
  幂律曲线用分数值𝜸将**较窄范围的暗输入值映射为较宽范围**的输出值，将高输入值映射为较窄范围的输出值

  > $0<\gamma<1$提高灰度级，图像变量。$\gamma>1$降低灰度级，图像变暗
  
- 分段线性变换函数  

  对比度拉伸，优：其形式可以任意复杂。缺：输入参数较多

  灰度层分级，突出图像中的特定灰度区间，去除背景， 增强前景

  ![image-20250609233808148](E:\notes_in_zju\docs\notes\cs\assets\数字图像处理Lec1_7.assets\image-20250609233808148.png)
  
  

## 直方图*

- 直方图

  - 将图像中像素亮度（灰度级别） 看成是随机变量， 其分布反映了图像统计特性，可用**概率密度函数**来刻画和描述
    $$
    h(r_k) = r_k,p(r_k) = \frac{h(r_k)}{MN} = \frac{n_k}{MN}
    $$

  - 性质：只反映该图像中不同灰度值出现次数， 而未反映某一灰度值像素所在位置， **即丢失了位置信息**——因此图像与直方图是**多对一**的映射关系

  - 直方图统计学信息公式

    一阶统计量（平均亮度）
    $$
    E = \sum_{k=0}^{L} z_k \cdot p(z_k)
    $$

    - 物理意义：图像整体亮度水平的数学期望
    - 计算范围：从灰度级最小值

    二阶统计量（对比度/标准差）
    $$
    \sigma = \sqrt{\sum_{k=0}^{L} (z_k - E)^2 \cdot p(z_k)}
    $$

    - 衍生指标：方差$  \sigma^2 = \text{std}^2  $
    - 工程意义：量化图像明暗变化剧烈程度

    N阶统计量（高阶特征）
    $$
    \mu_n = \sum_{k=0}^{L} (z_k - E)^n \cdot p(z_k)
    $$

- 直方图均衡化（Histogram Equalization）

  - 目的：通过调整图像灰度分布来**增强图像对比度**的全局性图像处理技术。其核心思想是将原始图像的灰度直方图从集中分布的区间转换为**近似均匀分布**，从而扩展像素值的动态范围，使图像细节更清晰、对比度更高

    设计一种变换$s=T(r)$，使得$p_s(s)=\frac{1}{L-1}$，其中在$0\le r\le1$时，$T(r)$值单调增加

    > **对比度**（Contrast Ratio）指图像或显示设备中 **最亮区域（白）与最暗区域（黑）的亮度比值**

  - 符号定义
    $  p_r(r)  $：原图像灰度级的概率密度函数（PDF）
    $  p_s(s)  $：变换后图像灰度级的概率密度函数
    $  T(r)  $：单调可逆变换函数（满足直方图均衡化条件）

    概率密度变换关系：
    $$
       p_s(s) = p_r(r) \left| \frac{dr}{ds} \right|
     
    $$

    要求变换函数$  s = T(r)  $ 连续可微且单调递增

    直方图均衡化变换：
    $$
    s = T(r) = (L-1) \int_0^r p_r(\omega) d\omega
    $$

    $$
    \frac{ds}{dr} = \frac{dT(r)}{dr} = (L-1) p_r(r)
    $$

    $$
       p_s(s) = p_r(r) \left| \frac{1}{(L-1) p_r(r)} \right| = \frac{1}{L-1}
     
    $$

    证明可得变换后PDF为均匀分布

    下面给出整体的具体步骤：

    1. 列出灰度级（形成一个表格）
    
    2. 计算统计直方图和累积直方图
    
    3. 使用公式：$g = 四舍五入[(L-1)\times g_f]$
    
       > 其中$L$是整体灰度级（一共多少个灰度级），$g_f$为对应的累积直方图
    
    4. 确定映射关系
    
    5. 计算新的直方图
    
       ![image-20250619175613980](./assets/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E2%80%94%E2%80%94%E7%81%B0%E5%BA%A6%E5%8F%98%E6%8D%A2%E4%B8%8E%E7%A9%BA%E9%97%B4%E6%BB%A4%E6%B3%A2.assets/image-20250619175613980.png)
    
    ![image-20250609234739674](./assets/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E2%80%94%E2%80%94%E7%81%B0%E5%BA%A6%E5%8F%98%E6%8D%A2%E4%B8%8E%E7%A9%BA%E9%97%B4%E6%BB%A4%E6%B3%A2.assets/image-20250609234739674.png)
    
  - 经过直方图均衡化处理后：

    - 输出图像的灰度级服从均匀分布
    - 对比度达到最大化
    - 变换函数本质是原图CDF的线性缩放

  - 所以用离散灰度级作变换一般得不到完全平坦的直方图是近似的概率密度函数，结果。另外，变换后的灰度级减少了，这种现象叫做**“简并”**现象。由于简并现象的存在，处理后的灰度级总是要减少的， 这是像素灰度有限  的必然结果。由于上述原因，处理后的灰度级总是要减少的，这是像素灰度有限数字图像的直方图均衡只是近似的

    | **优点**                  | **缺点**                             |
    | ------------------------- | ------------------------------------ |
    | 显著提升全局对比度        | 可能放大背景噪声                     |
    | 无需参数设置，自适应调整  | 丢失局部细节（如高光/阴影区域）      |
    | 适用于曝光不足/过度的图像 | 灰度级减少导致色阶断层               |
    | 计算效率高                | 对图像内容不加选择，可能破坏自然色调 |

- 直方图均衡$\to$均匀直方图

- 直方图匹配$\to$一定形态的直方图J

  其核心目标是让输入图像的色调和对比度与参考图像匹配，从而解决直方图均衡化“一刀切”的问题，实现更灵活的图像增强。
  $$
  G(z) = T(r)\to z=G^{-1}(T(r))
  $$
  离散化

  $$s = T(r) = (L - 1) \int_{0}^{r} p_r(w) dw$$

  $$s = G(z) = (L - 1) \int_{0}^{z} p_z(v) dv$$

  $$s_k = T(r_k) = (L - 1) \sum_{j=0}^{k} p_r(r_j)$$

  $$s_k = G(z_k) = (L - 1) \sum_{i=0}^{k} p_z(z_i)$$

  算法
  1. $  p_r  $ 是原始图像的概率密度函数，由其计算得到一系列值 $  s_k  $
  2. 由目标直方图计算 $  G(z_k)  $，得到一张查找表（$  z_k  $ 与 $  s_k  $）
  3. 由上述查找表，使用公式$G(z_k) = (L-1)\sum p_z(z_i)$进行计算

  ![image-20250609235015542](E:\notes_in_zju\docs\notes\cs\assets\数字图像处理Lec1_7.assets\image-20250609235015542.png)

- 自适应直方图均衡化

  与传统直方图均衡化的区别：根据图像的**局部区域**进行均衡化，从而避免了全局均衡化带来的过度增强或者失真的问题

  算法步骤

  1. 将图像分成若干个小的区域
  2. 对每个小区域进行直方图均衡化
  3. 将增强后的小区域合并成整张图像



## 空间滤波器*

空间滤波的核心是使用一个称为滤波器或核（kernel）的小窗口，在图像上滑动这个窗口，并用窗口中的像素值与滤波器的权重相乘后求和，来更新中心像素的值。这个过程可以用于图像的**平滑、锐化、边缘增强**等多种目的。

> 滤波有时要分多个阶段完成

- 相关Correlation
  $$
  (f*g)(x) = \sum f(t)\cdot g(x+t)
  $$
  操作本质：滤波器模板直接滑过图像，计算每个位置的乘积之和，**不翻转滤波器**。

  测量两信号的相似性，应用于图像匹配、特征检测等

- 卷积(常对称)Convolution
  $$
  (f*g)(x) = \sum f(t)\cdot g(x-t)
  $$
  操作本质：**先翻转滤波器180度**，再滑过图像计算乘积之和。

  述线性时不变系统的输入输出关系，如信号滤波、图像去噪等

  > 边缘处理：用0填充，镜像填充

  $$
  f*g =g*f,\quad f*(g+h)=f*g+f*h\\
  f*(g*h) = (f*g)*h
  $$

  归一化可保持图像处理前后亮度不变

- 空间滤波器设计

  - 根据其数学性质设计滤波器。例如，计算邻域像素平均值的滤波器会模糊图像，计算图像局部导数的滤波器会锐化图像

  - 对形状具有特定性质的二维空间函数进行取样。例如，使用来自高斯函数
    的样本可以构建加权平均（低通）滤波器

  - 设计具有规定频率响应的空间滤波器

- 噪声：不可预测，通常是用其数字特征，即均值方差、相关函数等进行处理

  - 按其产生原因可分为外部噪声和内部噪声

    - 外部噪声：系统外部干扰从电磁波或经电源传进系统内部而引起的噪声，如电气设备、天体放电现象等引起的噪声
    - 内部噪声：由系统电气设备内部引起的噪声（机械运动，元器件材料等）

  - 从统计特性可分为平稳噪声和非平稳噪声

    - 统计特性不随时间变化的噪声称为平稳噪声
    - 统计特性随时间变化的噪声称为非平稳噪声

  - 按噪声和信号之间的关系可分为加性噪声和乘性噪声

    为了分析处理方便，往往将乘性噪声近似认为加性噪声，而且总是假定信号和噪声是互相独立的

  - 特性：

    - 噪声在图像中的分布和大小不规则，即具有随机性
    - 噪声与图像之间具有相关性，例如摄像机信号与噪声相关，黑暗部分噪声大，明亮部分噪声小
    - 噪声具有叠加性

  - 图像去噪，改善降质图像的方法有两类：

    - 一类是**不考虑图像降质的原因**，只将图像中感兴趣的部分加以处理或突出有用的图像特征，故改善后的图像并不一定要去逼近原图像。这一类图像改善方法称为**图像增强**，主要目的是要提高图像的可懂度
    - 另一类方法是**针对图像降质的具体原因**，设法补偿降质因素，使改善后的图像尽可能地逼近原始图像。这类方法称为**图像恢复或图像复原**技术

  - 图像增强：图像增强处理的方法基本上可分为空间域法和频率法两大类

    - 空间域法：在原图像上直接进行数据运算，点运算，局部运算
    - 频域法：在图像的变换域上进行处理，增强感兴趣的频率分量，然后进行反变换得到增强了的图像

- 平滑（低通）滤波：作用去噪和平滑

  - 盒式滤波：一个均值滤波，算法简单，计算速度快，但其代价是会造成图像一定程度上的模糊

  - 高斯滤波：对于**抑制服从正态分布的噪声非常有效**

  - 统计排序滤波器/非线性滤波器

    - 中值滤波：降低脉冲噪声，减少模糊

      - 将读取的像素值按照大小进行排序（奇数点移动窗口）
      - 选取排序后中间的数值，或者中间数值的平均

      这是一种常用的，用于处理类似椒盐噪音那样，孤点信号的特殊方法。对一些细节多，特别是点、线、尖顶细节多的图像不宜采用中值滤波

    - 最大值/最小值滤波

      池化层，进行降采样常用最大值滤波

- 锐化（高通）滤波器：作用图像增强和锐化

  - 拉普拉斯滤波器

    常用的边缘增强算子，拉普拉斯运算也是**偏导数运算的线性组合运算**，而且是一种**各向同性**（旋转不变性）的线性运算
    $$
    \nabla^2 = \frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}
    $$
    拉普拉斯滤波器基于图像的二阶导数，用于突出图像的边缘。它的基本思想是当邻域的中心像素灰度低于它所在邻域内的其他像素的平均灰度时，此中心像素的灰度应该进一步降低；当高于时进一步提高中心像素的灰度，从而实现图像锐化处理。

    拉普拉斯滤波器更倾向于**检测到尖锐的边缘，**更容易**受到图像噪声的影响**

  - Sobel滤波器

    ```
    -1 -2 -1      -1 0 1
     0 0 0		  -2 0 2
     1 2 1		  -1 0 1
    ```

    采用梯度微分锐化图像，会使噪声、条纹等得到增强，Sobel算子则在一定程度上克服了这个问题

  - 梯度滤波器
    $$
    G[f(x, y)] = |f(i, j) - f(i + 1, j)| + |f(i, j) - f(i, j + 1)|
    $$
    以上梯度法又称为水平垂直差分法

    另一种梯度法叫做罗伯特梯度法（Robert Gradient），它是一种交叉差分计算法，其数学表达式为：

    $$
    G[f(x, y)] = \{[f(i, j) - f(i + 1, j + 1)]^2 + [f(i + 1, j) - f(i, j + 1)]^2\}^{\frac{1}{2}}
    $$
    同样可以简化为：

    $$
    G[f(x, y)] = |f(i, j) - f(i + 1, j + 1)| + |f(i + 1, j) - f(i, j + 1)|
    $$

  - 钝化掩蔽

    从原图像减去一幅钝化（平滑后）图像

    1. 模糊原图像。

    2. 从原图像减去模糊后的图像（产生的差称为模板）。
       $$
       f_h = f - f_L
       $$

    3. 将模板与原图像相加。
       $$
       f_{enhance} = f+kf_h
       $$
       

    <img src="assets/数字图像处理——灰度变换与空间滤波.assets/image-20250612003017604.png" alt="image-20250612003017604" style="zoom:50%;" />

  - 高提升滤波

    > 使用拉普拉斯来突出细节，使用梯度来增强突出的边缘。

- 带通滤波器，带阻滤波器

  ![image-20250612003104250](assets/数字图像处理——灰度变换与空间滤波.assets/image-20250612003104250.png)

- 组合空间增强

  空间滤波器组合应用

  ![image-20250612003200338](assets/数字图像处理——灰度变换与空间滤波.assets/image-20250612003200338.png)

  ![image-20250612003208528](assets/数字图像处理——灰度变换与空间滤波.assets/image-20250612003208528.png)



