# Lec 11 图像特征与理解



## 图像特征描述*

> 具有哪些不变性

把图像分割后，为了进一步的处理，一般要进行形式化的表达和描述

形式化表达一般有两种选择：

1. 根据区域的外部特征来进行形式化表示（例：边缘）
2. 根据区域的内部特征来进行形式化表示（例：纹理）

选择表达方式的原则

- 如果关注的焦点是形状特性，选择外部表示方式
- 如果关注的焦点是反射率特性，如颜色、纹理时，选择内部表示方式
- 所选表示方式，应该对尺寸、变换、旋转等变量尽可能的不敏感（可重复）

### 图像的几何特征

- 位置与方向：位置（centroid）

  - 物体面积的中心点作为物体的位置
  - 面积中心为单位面积质量恒定的相同形状图形的质心
  - 二值图像质量分布均匀，故**质心和形心**重合
  - 质心位置坐标：


$$
  \bar{x} = \frac{1}{mn} \sum_{i=0}^{n-1} \sum_{j=0}^{m-1} x_i, \quad \bar{y} = \frac{1}{mn} \sum_{i=0}^{n-1} \sum_{j=0}^{m-1} y_i
$$

- 位置与方向：方向（orientation）

  - 最小二阶矩轴（最小惯量轴在二维平面上的等效轴）定义为较长物体的方向

  - 找出一条直线，使下式定义的 $E$ 值最小：
    $$
    E = \iint r^2 f(x, y) \, dx \, dy
    $$
    其中，$r$ 是点 $(x, y)$ 到直线的垂直距离。

    ![image-20250611104643105](assets/数字图像处理Lec8_12.assets/image-20250611104643105.png)

- 周长：区域的周长即区域的边界长度

  - 形状简单的物体用相对较短的周长来包围它所占有面积内的像素，周长就是围绕所有这些像素的外边界的长度。

  - 区域的周长可区别具有简单或复杂形状物体。

  - 不同的计算方式，结果不同：

    1. 区域的周长即为区域和背景缝隙的长度和（隙码表示），周长24

       <img src="assets/数字图像处理Lec8_12.assets/image-20250611111158302.png" alt="image-20250611111158302" style="zoom:67%;" />

    2. 周长用边界所占面积表示，也即边界点数之和，每个点占面积为1的一个小方块。周长15

       <img src="assets/数字图像处理Lec8_12.assets/image-20250611111219252.png" alt="image-20250611111219252" style="zoom:67%;" />

    3. 当把像素看作一个个点时，则周长用**链码**表示，求周长也即计算链码长度。链码 （选取起始点 – 逆时针连接 – 用方向编号序列表示边界）

       周长为$10+5\sqrt{2}$

       ![](assets/数字图像处理Lec8_12.assets/image-20250611111624768.png)

       这里使用8方向链码，其中奇数长度为$\sqrt{2}$，偶数长度为$1$

- 面积：度量物体的总尺寸（像素）。下面给出一些计算方法：

  1. 像素计数面积：$A = \sum_{x=1}^{N} \sum_{y=1}^{M} f(x,y)$，用1表示物体，0表示背景

  2. 用边界坐标计算面积

     Green（格林）定理表明，在x-y平面中的一个封闭曲线包围的面积由其轮廓积分给定，即

     $$
     A = \frac{1}{2} \oint (x \, dy - y \, dx)
     $$
     其中，积分沿着该闭合曲线进行。将其离散化，变为

     $$
     A = \frac{1}{2} \sum_{i=1}^{N_b} [x_i (y_{i+1} - y_i) - y_i (x_{i+1} - x_i)] 
     \\
     = \frac{1}{2} \sum_{i=1}^{N_b} [x_i y_{i+1} - x_{i+1} y_i]
     $$
     式中，$  N_b  $ 为边界点的数目

  3. 由边界链码计算面积：

     设屏幕左上角为坐标原点，起始点坐标为 $ (x_0, y_0) $，第 $  k  $ 段链码终端的 $  y  $ 坐标为：

     $$y_k = y_0 + \sum_{i=1}^{k} \Delta y_i$$

     $$\Delta y_i = \begin{cases}-1 & \epsilon_i = 1, 2, 3 \\0 & \epsilon_i = 0, 4 \\1 & \epsilon_i = 5, 6, 7\end{cases}$$

     $ \epsilon_i $ 是第 $  i  $ 个码元。设：

     $$\Delta x_i = \begin{cases}1 & \epsilon_i = 0, 1, 7 \\0 & \epsilon_i = 2, 6 \\-1 & \epsilon_i = 3, 4, 5\end{cases}$$

     $$a = \begin{cases}\frac{1}{2} & \epsilon_i = 1, 5 \\0 & \epsilon_i = 0, 2, 4, 6 \\-\frac{1}{2} & \epsilon_i = 3, 7\end{cases}$$

     则相应边界所包围的面积为：

     $$
     A = \sum_{i=1}^{n} (y_{i-1} \Delta x_i + a)
     $$

- 距离

  - 欧式距离：$$d_e(P, Q) = \sqrt{(x - u)^2 + (y - v)^2}$$

  - 市区距离：$$d_4(P, Q) = |x - u| + |y - v|$$

    以 P 为起点的市区距离小于等于 t(t=1, 2, …) 的点形成以 P 为中心的菱形

  - 棋盘距离：$$d_8(P, Q) = \max(|x - u|, |y - v|)$$

    以 P 为起点的棋盘距离小于等于 t(t=1, 2, …) 的点形成以 P 为中心的正方形

  - $d_4、d_8$计算简便，且为正整数，因此常用来测距离，而欧几里德距离很少被采用

- 长轴、短轴和外接矩阵

  当物体的边界已知时，用其**外接矩形**的尺寸来刻画它的基本形状是最简单的方法。

  求物体在坐标系方向上的外接矩形，只需计算物体边界点的最大和最小坐标值，就可得到物体的水平和垂直跨度。

  但是：对任意朝向的物体，水平和垂直并非是感兴趣方向。

  **确定物体的主轴**，计算反映物体形状特征的主轴方向上的长度和与之垂直方向上的宽度，这样的外接矩形是物体的最小外接矩形（Minimum Enclosing Rectangle，MER）。下面给出MER的计算方法：

  <img src="assets/数字图像处理Lec8_12.assets/image-20250611113424697.png" alt="image-20250611113424697" style="zoom:67%;" />

  1. 将物体的边界以每次 $ 3^\circ $ 左右的增量在 $ 90^\circ $ 范围内旋转。每旋转一次记录一次其坐标系方向上的外接矩形边界点的最大和最小 $ x $、$ y $ 值。

  2. 旋转到某一个角度后，外接矩形的面积达到最小。

  3. 取面积最小的外接矩形的参数为主轴意义上的长度和宽度。

     > 几何特征在缩放变换下不守恒，需要归一化。

### 图像的形状特征

- 矩形度：反映物体对其外接矩形的充满程度
  $$
  R = \frac{A_O}{A_{MER}}
  $$
  $A_O$为该物体的面积，$A_{MER}$为$MER$的面积，圆形为$\frac{\pi}{4}$

- 长宽比：MER的长宽比：$r = \frac{W_{MER}}{L_{MER}}$，利用 r 可以将细长的物体与圆形或方形的物体区分开来

- 圆形度，一共有三种计算方法

  1. 致密度𝑪定义为周长𝑃的平方与面积𝐴的比：$C = \frac{P^2}{A}$

     致密度描述了区域单位面积的周长大小，致密度大，表明单位面积的周长大，即区域离散，则为复杂形状；反之，致密度小，则为简单形状

     圆形时取最小值$4\pi$，形状越复杂C越大，正方形$C = 16$

  2. 边界能量E：假定物体的周长为P，用变量 p 表示边界上的点到某一起始点的距离。边界上任一点都有一个瞬时曲率半径 r(p)，即该点与边界相切圆的半径。p点的曲率函数是$K(p) = \frac{1}{r(p)}$，函数K(p)是周期为P的周期函数。单位边界长度的平均能量：
     $$
     E = \frac{1}{P} \int_{0}^{P} |K^2(p)| dp
     $$
     面积相同时，圆具有最小边界能量$E_0 = (\frac{1}{R})^2$

     <img src="assets/数字图像处理Lec8_12.assets/image-20250611114136588.png" alt="image-20250611114136588" style="zoom:67%;" />

  3. 圆形性：一个用区域 R 的所有边界点定义的特征量，即$C = \frac{\mu_R}{\delta_R}$

     $ \mu_R $ 是从区域重心到边界点的平均距离，$ \delta_R $ 是从区域重心到边界点的距离均方差：

     $$
     \mu_R = \frac{1}{K} \sum_{k=0}^{K-1} \|(x_k, y_k) - (\bar{x}, \bar{y})\|
     \\
     \delta_R = \frac{1}{K} \sum_{k=0}^{K-1} \|\|(x_k, y_k) - (\bar{x}, \bar{y})\| - \mu_R\|^2
     $$
     当区域 $  R  $ 趋向圆形时，特征量 $  C  $ 是单调递增且趋向无穷的，它不**受区域平移、旋转和尺度变化的影响**，可以推广用于描述三维目标。

  4. 面积与平均距离平方的比值（形状度量公式）

     利用了从边界上的点到物体内部某点的平均距离 $ \bar{d} $，即

     $$
     \bar{d} = \frac{1}{N} \sum_{i=1}^{N} x_i
     $$
     式中，$ x_i $ 是从具有 $ N $ 个点的物体中的第 $ i $ 个点到与其最近的边界点的距离。相应的形状度量为（面积与平均距离平方的比值）

     $$
     g = \frac{A}{\bar{d}^2} = \frac{N^3}{\sum_{i=1}^{N} x_i}
     $$

- 球状性：$s=\frac{r_i}{r_c}，r_i\text{内切圆半径},r_c\text{外接圆半径}$

  区域为圆时, 球状性的值 S 达到最大值1.0，而当区域为其他形状时，则有S＜1.0。S 不受区域平移、旋转和尺度变化的影响

  <img src="assets/数字图像处理Lec8_12.assets/image-20250611114942889.png" alt="image-20250611114942889" style="zoom:67%;" />

- 不变矩：

  - 矩的定义：矩是描述数据分布和形态特征的度量

    对于二元有界函数 $  f(x, y)  $，它的 $ (j + k) $ 阶矩为

    $$
    M_{jk} = \int_{-\infty}^{+\infty} \int_{-\infty}^{+\infty} x^j y^k f(x, y) \, dx \, dy \quad j, k = 0, 1, 2, \ldots
    $$
    由于 $  j  $ 和 $  k  $ 可取所有的非负整数值，因此形成了一个矩的无限集。而且，这个集合完全可以确定函数 $  f(x, y)  $ 本身。即集合 $ \{M_{jk}\} $ 对于函数 $  f(x, y)  $ 是唯一的。

    零阶矩：$M_{00} = \int_{-\infty}^{+\infty} \int_{-\infty}^{+\infty}f(x, y) \, dx \, dy$是物体的面积。所有的一阶矩和高阶矩除以$M_{00}$后，与物体的大小无关。

  - 质心坐标与中心矩：当 $  j = 1, k = 0  $ 时，$  M_{10}  $ 对二值图像来讲就是物体上所有点的 $  x  $ 坐标的总和，反之，$  M_{01}  $ 就是物体上所有点的 $  y  $ 坐标的总和，则
    $$
    \bar{x} = \frac{M_{10}}{M_{00}}, \quad \bar{y} = \frac{M_{01}}{M_{00}}
    $$
    就是二值图像中一个物体的质心坐标。

    为了获得矩的不变特征，往往采用中心矩。中心矩的定义为

    $$
    M'_{jk} = \sum_{x=1}^{N} \sum_{y=1}^{M} (x - \bar{x})^j (y - \bar{y})^k f(x, y)
    $$

  - 不变矩：

    对于 $  j + k = 2, 3, 4, \ldots  $ 的高阶矩，可以定义归一化的中心矩为

    $$
    \mu_{jk} = \frac{M'_{jk}}{(M_{00})^r}, \quad r = \left( \frac{j + k}{2} + 1 \right)
    $$
    相对于面积归一化的低阶中心矩，在物体放大、平移、旋转时保持不变。但是三阶或更高阶的矩经过这样的规一化后不能保持不变性。

    利用归一化的中心矩，可以获得多个**不变矩组合，这些组合对于平移、旋转、尺度等变换都是不变的**。

    性质：

    - 高阶矩主要描述图像的细节， 而低阶矩主要描述图像的整体特征
    - 一个物体形体的唯一性体现在一个矩的无限集中，因此，要区别相似的形体需要一个**很大的特征集**；这样所产生的高维分类器**对噪声和类内变化十分敏感**。在某些情况下，几个阶数相对较低的矩可以反映一个物体的显著形状特征

- 边界特征（形状）描述子

  - 边界链码：利用一系列具有特定长度和方向的相连的直线段来表示目标的边界——对边界点的一种编码表示方法，可大大减少数据量

    数字图像一般是按固定间距的网格采集的，常用的有4方向和8方向链码
    
    ![image-20250611120750515](assets/数字图像处理Lec8_12.assets/image-20250611120750515.png)
    
    > 注意起点的选择，起点用绝对坐标表示。上图好像实际是用顺时针
    
    - 问题：
      码串比较长，噪声等干扰会导致小的边界变化从而使链码发生与目标整体形状无关的较大变动
    - 简单改进：对原边界以较大的网格重新采样，并把与原边界点最接近的大网格点定为新的边界点。该方案也可用于消除目标尺度变化链码的影响。
    
    - 对同一个边界，如用不同的边界点作为链码的起点，得到的链码则是不同的。使用**链码归一化**可解决这个问题
      1. 给定一个从任意点开始产生的链码，可把它看作一个由各方向数构成的自然数
      2. 首先，将这些方向数依一个方向循环，以使它们所构成的自然数的值最小
      3. 然后，将这样转换后所对应的链码起点作为这个边界的归一化链码的起点
    
  - 一阶差分链码

    - 链码问题：目标平移，链码不变；目标旋转，则链码会发生变化

    - 解决方案：利用链码的**一阶差分**来重新构造一个表示原链码各段之间方向变化的新序列，相当于把链码进行**旋转归一化**

      差分可用相邻两个方向数按反方向相减(后一个减去前一个)得到。

      通过计算相邻两个元素方向变化（**逆时针方向**）的数字得到。就是前一个数字变化到后一个数字需要经过的步数，注意是**逆时针方向**，比如**1->1经过0步，1->0经过7步**，对照8链码图仔细琢磨一下就知道了。一阶差分链码=0777177077070

      ![image-20250611132318935](assets/数字图像处理Lec8_12.assets/image-20250611132318935.png)

      归一化一阶差分链码，同上述链码归一化一样使其自然数最小

  - 傅里叶描述子

    - 对边界的离散傅立叶变换表达，可以作为**定量描述边界形状**的基础。
    
      将二维问题简化为一维问题。（离散傅立叶变换是个可逆线性变换）
    
    - 原理：
    
      将x-y平面中的曲线段转化为复平面上的一个序列则可用复数$u+jv $表示给定边界上的每个点$(x，y)$
    
      <img src="assets/数字图像处理Lec8_12.assets/image-20250611132723842.png" alt="image-20250611132723842" style="zoom:67%;" />
    
      考虑一个由 $  N  $ 个点组成的封闭边界，从任一点开始绕边界一周就得到一个复数序列
      $$
      s(k) = u(k) + jv(k) \quad k = 0, 1, \ldots, N - 1
      $$
      $  s(k)  $ 的离散傅立叶变换是
      $$
      S(\omega) = \frac{1}{N} \sum_{k=0}^{N-1} s(k) e^{-j \frac{2 \pi \omega k}{N}} \quad \omega = 0, 1, \ldots, N - 1
      $$
      $  S(\omega)  $ 可称为边界的傅立叶描述，它的傅立叶逆变换是
      $$
      s(k) = \frac{1}{N} \sum_{\omega=0}^{N-1} S(\omega) e^{j \frac{2 \pi \omega k}{N}} \quad k = 0, 1, \ldots, N - 1
      $$
    
      - 离散傅立叶变换是个**可逆线性变换**，在变换过程中信息没有任何增减
    
      - 只取 $  S(\omega)  $ 的前 $  M  $ 个系数即可得到 $  s(k)  $ 的一个近似：
        $$
        \tilde{s}(k) = \frac{1}{N} \sum_{\omega=0}^{M-1} S(\omega) e^{-j \frac{2 \pi \omega k}{N}} \quad k = 0, 1, \ldots, N - 1
        $$
    
        > Tips：上式中 $  k  $ 的范围不变，即在近似边界上的点数不变，但 $  \omega  $ 的范围缩小了，即为重建边界点所用的频率项少了。
    
      - **傅立叶变换的高频分量对应一些细节，而低频分量对应总体形状**，因此用一些低频分量的傅立叶系数足以近似描述边界形状。




### 图像的纹理特征

纹理(Texture)一词最初指纤维物的外观， 一般来说， 可以认为纹理是由许多相互接近的、 互相编织的元素构成， 它们富有周期性

<img src="assets/数字图像处理Lec8_12.assets/image-20250611143705189.png" alt="image-20250611143705189" style="zoom:67%;" />

> 没有精确定义

- 局部区域呈现不规则性、 而在整体上表现出某种规律性  

- 纹理的基本特征：重复性、 规则性、 周期性、 方向性

- 纹理应用：纹理分割、 纹理分类、 纹理合成

- 纹理描述：**统计法、 结构法、 频谱法**。

  - 统计法：利用灰度直方图的矩来描述纹理， 可采用**灰度差分统计法**

    设 $ (x, y) $ 为图像中的一点，该点与和它只有微小距离的点 $ (x + \Delta x, y + \Delta y) $ 的灰度差值为

    $$
    g_\Delta(x, y) = g(x, y) - g(x + \Delta x, y + \Delta y)
    $$
    $ g_\Delta $ 称为灰度差分。设灰度差分的所有可能取值共有 $ m $ 级，令点 $ (x, y) $ 在整个画面上移动，累计出 $ g_\Delta(x, y) $ 取各个数值的次数，由此便可以作出 $ g_\Delta(x, y) $ 的直方图。
  
    由直方图可以知道 $ g_\Delta(x, y) $ 取值的概率 $ p_\Delta(i) \quad (i = 1, \cdots, m) $
  
    某个 $ i $ 值概率 $ p_\Delta(i) $ 较大时，说明纹理较粗糙；概率分布较平坦时，说明纹理较细。
  
    该方法采用以下参数描述纹理图像的特征：
  
    - 对比度：$$CON = \sum_i i^2 p_\Delta(i)$$
    
    
      - 角度方向二阶矩：$$ASM = \sum_i [p_\Delta(i)]^2$$
    
    
      - 熵：$$ENT = - \sum_i p_\Delta(i) \log p_\Delta(i)$$
    
    
      - 平均值：$$MEAN = \frac{1}{m} \sum_i i p_\Delta(i)$$
    
        ![比较](assets/数字图像处理Lec8_12.assets/image-20250611144654268.png)
    
    
    
      - $ p_\Delta(i) $ 较平坦时，$ ASM $ 较小，$ ENT $ 较大；
    
    
      - 若 $ p_\Delta(i) $ 分布在原点附近，则 $ MEAN $ 值较小。
    
  
  
  - 结构法：空间**自相关函数**作纹理测度
  
    具体步骤：设图像为 $  f(i, j)  $，自相关函数可由下式定义：
  
    $$
    C(x, y) = \frac{\sum_{i=1}^{N} \sum_{j=1}^{N} f(i, j) f(i + x, j + y)}{\sum_{i=1}^{N} \sum_{j=1}^{N} [f(i, j)]^2}
    $$
    上式是对图像每一个像素点 $ (i, j) $ 与偏离值为 $ (x, y) $ 的像素之间的相关值进行计算。定义距离$$d = \sqrt{x^2 + y^2}$$
  
    $  C(x, y)  $ 随 $  d  $ 大小而变化的规律，可以描述图像的纹理特征
  
    - 粗纹理的自相关函数随距离的增大，下降速度较慢；细纹理的下降速度较快；
    - 如果**纹理灰度呈周期变化，则自相关函数的升降也呈周期性变化**，其周期大小可作为描述纹理的重要特征，反映局部模式排列规则的稀疏、稠密程度
  
  - 频谱法：使用傅立叶频谱的频率特性来描述周期的或近乎周期的二维图像模式的方向性
  
    常用的三个性质：
  
    1. 傅立叶频谱中突起的峰值对应纹理模式的主方向；
    2. 这些峰在频域平面的位置对应模式的基本周期；
    3. 如果利用滤波把周期性成分除去，剩下的非周期性部分可用统计方法描述。
    
    可把频谱转化到极坐标系（半径和方向角）中，此时频谱可用函数 $  S(r, \theta)  $ 表示。
    
    对确定的方向 $ \theta $，$  S(r, \theta)  $ 是一个一维函数 $  S_\theta(r)  $；
    - 对给定的 $ \theta $，分析 $  S_\theta(r)  $ 得到的频谱**沿原点射出方向**的行为特性；
    
    对确定的频率 $  r  $，$  S(r, \theta)  $ 是一个一维函数 $  S_r(\theta)  $；
    - 对给定的 $  r  $，分析 $  S_r(\theta)  $ 得到的频谱在**以原点为中心的圆上**的行为特性。
    
    把这些函数对下标求和可得到更为全局性的描述，即
    
    $$
    S(r) = \sum_{\theta=0}^{\pi} S_\theta(r),S(\theta) = \sum_{r=1}^{R} S_r(\theta)
    $$
    式中，$  R  $ 是以原点为中心的圆的半径。
    
    $  S(r)  $ 和 $  S(\theta)  $ 构成整个图像或图像区域纹理频谱能量的描述。
    
    ![image-20250611145725447](assets/数字图像处理Lec8_12.assets/image-20250611145725447.png)

### 骨架、中轴和距离变换

- 骨架：用细化技术得到骨架

  获取骨架的方法：

  - 拓扑保持细化：在保持端点和线的连通性的同时， （如使用形态学腐蚀） 连续细化区域
  
  - 中轴变换： 一种确定物体骨架的细化技术
  
    中轴变换过程：具有边界 $  B  $ 的区域 $  R  $ 的中轴变换过程：
    - 对每个 $  R  $ 中的点 $  p  $，在 $  B  $ 中找到它的最近邻点
    - 如果 $  p  $ 有多个这样的邻点，那么它们属于 $  R  $ 的中轴
  
    每个骨架点保持了其与边界点距离最小的性质
  
    恢复：以每个骨架点为中心的圆的集合，就可恢复出原始的区域
    - 以每个骨架点为圆心，以前述最小距离为半径作圆
    - 它们的包络线就构成了区域的边界，填充圆周就得到区域
  
    骨架是用一个点与一个点集的最小距离来定义的
  
    $$
    d_s(p, B) = \inf \{ d(p, z) \mid z \in B \}
    $$
  
    - 距离量度可以是欧几里得、市区或棋盘距离
    - 因为最小距离取决于所用的距离量度，所以 MAT 的结果也和所用的距离量度有关
  
  - 距离变换
  
    零值背景中的前景像素区域距离变换，是从每个像素到最近**非零值**像素的距离
  
    图像的 MAT（骨架）等效于图像的补集的距离变换的脊
    - 图像补集的距离构成了区域边界
    - 距离变换的脊是局部极大值的集合
  
    ![image-20250611152733871](assets/数字图像处理Lec8_12.assets/image-20250611152733871.png)

### 其他特征或描述

- 标记signature：

  - 基本思想：把二维的边界用一维的较易描述的函数形式来表达

  - 产生标记最简单的方法：把质心到边界距离画成角度的函数

    ![image-20250611152938982](assets/数字图像处理Lec8_12.assets/image-20250611152938982.png)

    - 该方法产生的标记不受目标平移的影响，但**与尺度变换及旋转都有关**
    - 尺度变换会造成标记的幅度值发生变化，可用**最大幅值归一化**到单位值得方法来解决
    - **解决旋转影响**常用的方法有
      1. 选离重心最远的点作为标记起点
      2. 求出边界主轴，以主轴上离重心最远的点作为标记起点

- 欧拉数与孔洞数

  - 区域的拓扑性质既不依赖距离，也不依赖基于距离测量的其他特性

  - 把区域中的孔洞数𝑯作为拓扑描述子

    这个性质不受伸长、旋转的影响，但如果撕裂或折叠时孔洞数会发生变化

  - 区域内的连接部分C的个数是区域的另一拓扑特性

  - 欧拉数$E = C -H$

    ![image-20250611153211002](assets/数字图像处理Lec8_12.assets/image-20250611153211002.png)

- 四叉树

  四叉树表示图像是一个“金字塔”式的观察和处理过程

  这种数据结构是一种有效的对空间占有数组的编码，可以很好地描述一幅图像

  当图像像素点的个数是2的整数次幂（即图像尺寸为 $ 2^k \times 2^k $）时四叉树法最适用
  所有节点可分成三类：目标节点、背景节点和混合节点
  四叉树的树根对应整幅图，而树叶对应各个单个像素或具有相同特性的像素组成的方阵

  四叉树由多级构成，数根在0级，分一次叉多一级

  对一个有 $  n  $ 级的四叉树，其节点总数 $  N  $ 最多为
  $$
  N = \sum_{i=0}^{n} 4^i = \frac{4^{n+1} - 1}{3} \approx \frac{4}{3} 4^n
  $$

  - 优：

    四叉树容易生成得到， 根据它可方便地计算区域特征。本身的结构特点使得它常用在**“粗略信息优先”**的表示

  - 缺：

    如果节点在树中的级确定后，分辨率就不可能进一步提高

  


## 图像特征提取*

- 特征点提取*

  - Harris角点检测

    - 角点：局部窗口沿各方向移动，均产生明显变化的点。图像局部曲线曲率突变的点

    - 基本思想：

      - 从图像局部的小窗口观察图像特征
      
      - 当存在角点时，窗口向任意方向的移动都导致图像灰度的明显变化
      
    - 数学原理：

      （令 $  I  $ 表示图像）：将图像窗口平移 $ [u, v] $ 产生灰度变化 $  E(u, v)  $

      $$
      E(u, v) = \sum_{x,y} w(x, y) [I(x + u, y + v) - I(x, y)]^2
      $$

      > $w(x,y)$为窗函数

      移位后的小块图像 $  I(x + u, y + v)  $ 进行泰勒级数展开得 $  I(x + u, y + v) = I(x, y) + I_x u + I_y v + o(u^2, v^2)  $ 忽略高阶项，带入整理得
      $$
      E(u, v) = \sum_{x,y} w(x, y) [I_x u + I_y v]^2
      $$
      于是对于局部微小的移动量 $ [u, v] $，可以近似得到表达

      $$
      E(u, v) \cong [u \quad v] M \begin{bmatrix} u \\ v \end{bmatrix}
      $$
      其中 $  M  $ 为 $  2 \times 2  $ 矩阵，可由图像的导数得到

      $$
      M = \sum_{x,y} w(x, y) \begin{bmatrix} I_x^2 & I_x I_y \\ I_x I_y & I_y^2 \end{bmatrix}
      $$
      使用 $  M  $ 的特征值表达图像点局部灰度变化情况，定义角点响应函数 $  R  $
      $$
      R = \lambda_1 \lambda_2 - k (\lambda_1 + \lambda_2)^2 = det(M) - k(trace~ M)^2
      $$
      记 $\lambda_{max}, \lambda_{min}$ 为 $M$ 的两个特征值，$k$为敏感因子，𝑘越小，检测器就越可能找到角

      好的角点沿着任意方向移动都将导致明显的图像灰度变化，即 $R$ 具有大的正值数。

      > 噪声容易被误判成角点，需要增大阈值或参数k

    - 算法步骤

      1. 输入图像
      2. 计算每一点的梯度$I_x,I_y$
      3. 对每个点构建$M$，求角点响应函数$R$
      4. 提取$R$的局部极值
      5. 角点特征

    - Harris角点检测算子的性质

      - 旋转不变性：角点响应函数𝑅对于图像的旋转具有不变性

      - 对于图像灰度的仿射变换具有部分的不变性

        因为只使用了图像的导数，所以对于**灰度平移变化**具有不变性$I\to I+b$

        而对于图像灰度的**尺度变化**不具有不变性$I\to aI$

      - 对于图像几何尺度变化**不具有**不变性

  - SIFT特征点检测(Scale Invariant Feature Transform)

    - 迄今使用最为广泛的特征，DoG特征检测+SIFT描述子

    - SIFT特征性质

      SIFT特征是图像的局部特征，其对**旋转、尺度缩放、亮度**变化保持不变性，对**视角变化、仿射变换、噪声**也保持一定程度的稳定性。

    - 算法步骤

      1. 尺度空间的生成

         尺度空间：$L(x,y,\sigma) = G(x,y,\sigma)*I(x,y)$

         可变尺度高斯核 $  G(x, y, \sigma) = \frac{1}{2 \pi \sigma^2} e^{-\frac{(x^2 + y^2)}{2 \sigma^2}}  $

         $ \sigma $ 为尺度参数，当 $ \sigma $ 连续变化，$  G(x, y, \sigma)  $ 构成了图像的尺度空间

         输入图像 $  I(x, y)  $ 依次与标准差为 $ \sigma, k\sigma, k^2\sigma, k^3\sigma, \cdots $ 的高斯核卷积，生成一堆由一个常量因子 $  k  $ 分隔的高斯滤波（平滑）图像

         通常金字塔层数(Octaves)为4\~6层，每层层数（使用不同高斯核进行平滑）常3\~6幅

         SIFT将尺度空间细分为倍频程(Octave)。生成高斯金字塔：(1）高斯平滑（2）降采样

         <img src="assets/数字图像处理Lec8_12.assets/image-20250611155924795.png" alt="image-20250611155924795" style="zoom:50%;" />

         然后生成高斯差分尺度空间（DoG Pyramid）：

         高斯差分DoG：
         $$
         D(x,y,\sigma) = L(x,y,k\sigma) - L(x,y,\sigma)
         $$

         - 尺度归一化LoG（Laplacian of Gaussian）空间中提取的图像特征的稳定性最好
         - **高斯差分是对尺度归一化LoG的一个很好的近似**，而尺度归一化的LoG空间具有真正的尺度不变性。计算量减少2/3

         ![image-20250610120130900](assets/数字图像处理Lec8_12.assets/image-20250610120130900.png)

      2. 检测尺度空间极值点

         高斯差分尺度空间极值点检测

         在 $  D(x, y, \sigma)  $ 图像中的每个位置，将该位置的像素值与其在当前图像中的8的相邻像素值及其在上方和下方图像中的9个相邻像素共26个像素进行比较
      
         若该点为局部极值点，则保存为候选关键点
      
      3. 精确定位极值点
      
         离散空间的极值点并不是真正的极值点
      
         ![image-20250611160528311](assets/数字图像处理Lec8_12.assets/image-20250611160528311.png)
      
         为了提高关键点的稳定性，需要对 $  D(x, y, \sigma)  $进行插值
      
         在被检测的样本点处对 $  D(x, y, \sigma)  $ 进行二阶泰勒展开并舍掉余项，有
      
         $$
         D(x) \approx D + \frac{\partial D}{\partial x} x + \frac{1}{2} x^T \frac{\partial^2 D}{\partial x^2} x = D + \frac{\partial D}{\partial x} x + \frac{1}{2} x^T \frac{\partial^2 D}{\partial x^2} x
         $$
         对 $  x  $ 求导并令其为零，可求得极值位置 $  \hat{x}  $ 以及极值 $  D(\hat{x})  $
      
         $$
         \hat{x} = -\frac{\partial^2 D^{-1}}{\partial x^2} \frac{\partial D}{\partial x}, \quad D(\hat{x}) = D + \frac{\partial D}{\partial x} \hat{x}
         $$
         其中 $  \hat{x} = (\hat{x}, \hat{y}, \hat{\sigma})^T  $ 为该样本的偏移量
      
         三个变量任意一个偏移量大于0.5（精确极值点更接近于另一个邻点），则更新后重新计算
      
         获得真正极值点后再去除不稳定的关键点
      
         - 去除对比度低的点：设定DoG阈值
         - 去除边缘上的点：利用Hessian矩阵𝑯判断关键点是否位于边缘——H的两个特征值比例大于阈值
      
      4. 为每个关键点指定方向参数，主方向计算
      
         根据局部图像性质为每个关键点分配一个一致的方向，以便实现图像的**旋转不变性**
      
         1. 使用关键点的尺度来选择最接近该尺度的高斯平滑图像L
      
         2. 在该尺度$\sigma$中，计算以关键点为圆心的圆域内所有像素的梯度幅度M和方向角θ
      
         3. 计算梯度方向直方图
      
            > 直方图中的最高峰值方向代表了关键点的主方向
      
         4. 抛物线插值来精确定位主方向
      
      5. 关键点描述子的生成
      
         1. 在关键点对应的高斯图像L上，进行关键点的主方向校正
      
         2. 确定计算描述子所需的区域
      
            以关键点为中心，将其附近邻域划分为4 × 4个子区域每个子区域的尺寸为4 × 4像素关键点邻域区域一共应有16 × 16个像素
      
         3. 计算关键点邻域的所有像素梯度并统计各个子区域的梯度直方图
      
            每个子区域作为一个种子点，需统计8个方向的梯度强度信息（将360°划分8个方向，每个方向为45°）
      
            > “边界”效应：因描述子方向的微小变化导致的，为不同方向分配同一个值
            >
            > 为避免“边界”效应，需对梯度幅值进行插值运算
      
            对𝟒 × 𝟒个子区域进行8方向梯度直方图计算，该关键点的描述子为 𝟒 × 𝟒 × 𝟖 = 𝟏𝟐𝟖维特征向量
      
         4. 关键点描述子优化
      
            - 为了改善**特征受光照条件**的影响，需要优化特征向量
      
            - 对于线性光照变化：对特征向量进行归一化处理
      
              记该关键点的特征向量为 $  P = \{p_1, p_2, \cdots, p_{128}\}  $
      
              记归一化后的特征矢量为 $  Q = \{q_1, q_2, \cdots, q_{128}\}  $
      
              归一化处理：
      
              $$q_i = \frac{p_i}{\sqrt{\sum_{j=1}^{128} p_j^2}}, \quad i = 1, 2, \cdots, 128$$
      
            - 对于由相机饱和等导致的非线性光照变化：阈值处理

  - SURF特征点检测

    - 积分图像：积分图像中任意一点 𝑥, 𝑦 的值为原图像左上角到该任意点 𝑥, 𝑦 相应的对角线区域的灰度值的总和（用于加速算法计算）
    
    - SURF采用的是海森矩阵(Hessian Matrix)的行列式近似值建立影像空间
    
    - SURF采用了盒式滤波器（Box Filters）简化代替LoG
    
      > SIFT利用DoG近似LoG
    
    |            | SIFT                                                         | SURF                                                         |
    | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
    | 尺度空间   | DoG与不同尺度的图片卷积                                      | 不同尺度的Box Filters与原图片卷积                            |
    | 特征点检测 | 先进行非极大抑制，再去除低对比度的点，再通过Hessian矩阵去除边缘的点 | 先利用Hessian矩阵行列式确定候选点，然后进行非极大抑制        |
    | 方向       | 在正方形区域内，统计梯度的幅值的直方图，找最大值对应的方向（可以有多个方向） | 在圆形区域内，计算各个扇形范围内x、y方向的Haar小波响应，找最大的扇形方向 |
    | 特征描述子 | 16×16的采样点划分为4×4的区域，计算每个区域的采样点的梯度方向和幅值，统计成8bin直方图，一共4×4×8=128维 | 20s×20s的区域划分为4×4的子区域，每个子区域找5s×5s个采样点，计算采样点的Haar小波响应，记录Σdx、Σdy、Σ\|dx\|、Σ\|dy\|，一共4×4×4=64维 |
    
    对比：
    
    - SURF速度快，较SIFT速度检测和匹配，有3倍速度提高，性能和SIFT大体相当 
    - SURF在图像模糊和旋转不变上优于SIFT
    - SURF在图像视点变化和光照变化上略差于SIFT

- 直线特征提取

  - Canny算子
  
- 区域特征提取

  - 最大稳定极值区域MSER：目前业界认为是性能最好的仿射不变区域检测算法
  
    > 仿射不变区域前提条件：
    >
    > - 场景中物体局部表面可以近似平面
    > - 透视产生的形变可以忽略，则区域特征之间的几何形变可以近似为“仿射变换”
  
    MSER是使用不同的灰度阈值对图像进行二值化得到的最稳定的区域
  
    提取过程：
  
    1. 使用一系列灰度阈值对图像进行二值化处理
  
    2. 对于每个阈值得到的二值图像得到相应的黑色区域与白色区域
  
    3. 在比较宽的灰度阈值范围内保持形状稳定的区域就是MSERs
  
       评判标准：$  \frac{dA}{dt}  $，$  A  $-二值图像区域面积；$  t  $-灰度阈值
  
    MSER提取过程可以转换为有根的连通树(称为分量树)
  
    构造仿射不变性区域
  
    1. 待匹配的图像
    2. 分别提取仿射不变区域
    3. 用椭圆代表区域形状
    4. 将椭圆归一化为单位圆
    5. 旋转对齐主方向，灰度归一化



## 图像匹配*

- 模板匹配

  - 模板：一幅已知的小图像

  - 模板匹配：在一副图像中寻找与另一幅模板图像最匹配（相似）部分

    使用预设模板在图像中移动，并通过计算模板与图像重合部分的相关性来实现图像匹配，从而确定目标的位置

  - 下面介绍几种模板匹配算法

    1. 相关法

       数学原理：

       数学模型：以8位灰度图像为例，模板 $  T(m, n)  $ 叠放在被搜索图 $  S(H, W)  $ 上平移

       模板覆盖被搜索图的区域为子图𝑆𝑖𝑗（𝑖、j为子图左上角在被搜索图𝑆上的坐标）

       1. 计算 $  T  $ 和 $  S_{ij}  $ 的相似性(平方差之和)：
          $$
          D(i, j) = \sum_{m=1}^{M} \sum_{n=1}^{N} [S^{ij}(m, n)]^2 - 2 \sum_{m=1}^{M} \sum_{n=1}^{N} S^{ij}(m, n) \times T(m, n) + \sum_{m=1}^{M} \sum_{n=1}^{N} [T(m, n)]^2
          $$

       2. 将其归一化，得到模板匹配的相关系数：
          $$
          R(i, j) = \frac{\sum_{m=1}^{M} \sum_{n=1}^{N} S^{ij}(m, n) \times T(m, n)}{\sqrt{\sum_{m=1}^{M} \sum_{n=1}^{N} [S^{ij}(m, n)]^2} \sqrt{\sum_{m=1}^{M} \sum_{n=1}^{N} [T(m, n)]^2}}
          $$

       当模板和子图完全一样时，相关系数 $  R(i, j) = 1  $

       在被搜索图 $  S  $ 中完成全部搜索后，找出 $  R  $ 的最大值 $  R_{\text{max}}(im, jm)  $，其对应的子图 $  S_{ijm}  $ 即为匹配目标

       缺点：该方法计算量大，速度较慢

    2. 误差法

       数学模型：以8位灰度图像为例，模板 $  T(m, n)  $ 叠放在被搜索图 $  S(H, W)  $ 上平移

       1. 计算 $  T  $ 和 $  S_{ij}  $ 的误差：
          $$
          E(i, j) = \sum_{m=1}^{M} \sum_{n=1}^{N} |S_{ij}(m, n) - T(m, n)|
          $$

       2. $  E(i, j)  $ 为最小值处即为匹配目标

       3. 为提高计算速度，设置误差阈值 $  E_0  $。当 $  E(i, j) > E_0  $，就停止该点计算，继续计算下一点

    3. 二次匹配误差法

       数学模型：以8位灰度图像为例，模板 $  T(m, n)  $ 叠放在被搜索图 $  S(H, W)  $ 上平移

       二次匹配误差法中匹配分两次进行：

       1. 第一次匹配是粗略匹配
          
          取模板的隔行隔列数据，即1/4的模板数据，在被搜索图上进行隔行隔列扫描匹配，即原图的1/4范围内匹配（由于数据量大幅度减少，因而匹配速度显著提高）
          
       2. 第二次匹配是精确匹配
          
          在第一次误差最小点 $ (i_{\text{min}}, j_{\text{min}}) $ 的邻域内，即在对角点为 $ (i_{\text{min}} - 1, j_{\text{min}} - 1) $，$ (i_{\text{min}} + 1, j_{\text{min}} + 1) $ 的矩形内进行搜索匹配，得到最后的结果

       实验结果表明，二次匹配误差法的速度比其原算法快10倍左右

- 直方图匹配

  借助图像特征的统计直方图进行图像的匹配。

  特征：由于直方图丢失了颜色的位置信息，因此两幅图像可能内容完全不同，但直方图相似。所以，仅用简单的颜色直方图匹配也容易造成误识别

  一种改进的方法是将图像划分成若干子块，分别对各子块进行匹配

  下面介绍几种方法：

  1. 直方图相交法

     设 $  H_Q(k)  $ 和 $  H_D(k)  $ 分别为查询图像 $  Q  $ 和数据库图像 $  D  $ 的特征统计直方图，则两图像之间的匹配值 $  d(Q, D)  $ 为：

     $$
     d(Q, D) = \frac{\sum_{k=0}^{L-1} \min[H_Q(k), H_D(k)]}{\sum_{k=0}^{L-1} H_Q(k)}
     $$

  2. 欧几里德距离法

     为减少计算量，可采用直方图的均值来粗略地表达颜色信息，对图像的 $  R, G, B  $ 三个分量，匹配的特征向量 $  f  $ 为：$$f = [\mu_R, \mu_G, \mu_B]^T$$

     > $$\mu_R, \mu_G, \mu_B \text{分别为} R, G, B \text{三分量直方图的均值}$$

     此时查询图像查询图像 $  Q  $ 和数据库图像 $  D  $ 之间的匹配值为：
     $$
     d(Q, D) = \sqrt{(f_Q - f_D)^2} = \sqrt{\sum_{R,G,B} (\mu_Q - \mu_D)^2}
     $$

  3. 中心矩法

     对直方图来说，均值是其零阶矩，更高阶的矩也可以使用

     设用 $  M_{QR}^i  $、$  M_{QG}^i  $、$  M_{QB}^i  $ 分别表示查询图像 $  Q  $ 的 $  R, G, B  $ 三个分量直方图的 $  i(i \leq 3)  $ 阶中心矩；
     设用 $  M_{DR}^i  $、$  M_{DG}^i  $、$  M_{DB}^i  $ 分别表示数据库图像 $  D  $ 的 $  R, G, B  $ 三个分量直方图的 $  i(i \leq 3)  $ 阶中心矩；
     则它们之间的匹配值为：

     $$W_R, W_G, W_B \text{为加权系数}$$

     $$
     d(Q, D) = \sqrt{W_R \sum_{i=1}^{3} (M_{QR}^i - M_{DR}^i)^2 + W_G \sum_{i=1}^{3} (M_{QG}^i - M_{DG}^i)^2 + W_B \sum_{i=1}^{3} (M_{QB}^i - M_{DB}^i)^2}
     $$

  4. 参考颜色法

     直方图相交法计算量太大；RGB距离法太粗糙；

     一种折中的方法是将图像颜色用一组参考色表示
     - 这组参考色应能覆盖视觉上可感受到的各种颜色
     - 参考色的数量要比原图像少，这样子可计算简化的直方图

     匹配的特征向量为：

     $$f = [r_1, r_2, \cdots, r_N]^T$$

     $$r_i \text{是第} i \text{种颜色出现的频率}, \quad N \text{是参考颜色表的尺寸}$$

     加权后的查询图像 $  Q  $ 和数据库图像 $  D  $ 之间的匹配值为：

     $$
     d(Q, D) = \sqrt{\sum_{i=1}^{N} W_i (r_{iQ} - r_{iD})^2} 
     \\
     W_i = \begin{cases} r_{iQ} & r_{iQ} > 0 \text{且} r_{iD} > 0 \\1 & r_{iQ} = 0 \text{或} r_{iD} = 0 \end{cases}
     $$

  5. 闵可夫斯基距离法

     若两幅图像 $  Q  $ 和 $  D  $ 的直方图分别为 $  H_Q  $ 和 $  H_D  $，则颜色直方图匹配的计算方法可以利用度量空间的闵可夫斯基距离

     $$
     d(x, y) = \left( \sum |\xi_i - \eta_i|^\lambda \right)^{\frac{1}{\lambda}}
     $$
     当 $ \lambda = 1 $ 时，为市区距离
     
     按如下方法匹配：
     
     $$
     d(Q, D) = \sum_{k=0}^{L-1} |H_Q(k) - H_D(k)|
     $$
     $  R, G, B  $ 图像颜色是由不同亮度的红、绿、蓝三基色组成的，则改写成：
     
     $$d_{RGB}(Q, D) = \sum_{k=0}^{L-1} \left[ |H_Q^r(k) - H_D^r(k)| + |H_Q^g(k) - H_D^g(k)| + |H_Q^b(k) - H_D^b(k)| \right]$$

- 形状匹配

  形状是对目标范围的二值图像表示，可以看成是目标的轮廓，它是目标识别的重要特征。

  通常有两种表达方法：

  1. 编码方式：如链码、游程码、Freeman码等
  2. 简化方式：如样条（B样条等）、插值、多项式、多边形逼近和特征点检测等

  根据匹配方法处理形变的能力，可将形状匹配方法分为两大类：

  1. 一类只能处理各种变换引起的形状变化
     - 如相似不变量（距离、矩、角度、圆度、Fourier描述子）
     
       - 矩

         优点是具有简练的数学表示
     
         缺点是要建立高阶矩和形状特征的联系困难，另外它不能检测形状的局部特征
     
       - Fourier描述子
     
         傅立叶描述子在一定条件下，具有位移、旋转、大小、起点等不变的性质
     
         优点:易于实现，并且建立在傅立叶分析的成熟理论之上
     
         缺点:傅立叶变换不提供局部形状信息，角累加函数的表示对噪声很敏感
     
     - 仿射不变量（简比、弧长、包围面积、改进型Fourier描述子）
     
     - 透视不变量（交比及其延伸）
     
  2. 另一种可以处理更加复杂的形变
     - 它们通过寻找目标和模型之间局部特征的对应，使得匹配误差最小
     - 如广义Hough变换、动态规划、神经网络、变形模板、遗传算法等

- 特征匹配

  ![image-20250611171657711](assets/数字图像处理Lec8_12.assets/image-20250611171657711.png)

  目的：通过描述子的差异把两张图中相同的特征点一一对应起来

  1. 暴力匹配
     - 对左图中的每一个特征点，计算它和右图所有特征点的相似程度（特征描述子的距离），然后按照相似程度进行排序，取最相似的那个作为匹配值
     - 计算复杂，误匹配率高

  2. 握手匹配（交叉验证）
     - 在暴力匹配基础上用右图特征点和左图的所有特征点进行匹配，取这两个匹配对的交集
     - 计算复杂度至少是暴力匹配的2倍

  如何判断两个特征是否更相似：

  - 两个描述子的欧式距离计算
    $$
    DIS_{ij} = \left[ \sum_{k=1}^{n} (x_{ik} - x_{jk})^2 \right]^{\frac{1}{2}}
    $$
    $$x_{ik} \text{表示待配准图中第} i \text{个特征描述子的第} k \text{个元素}$$

    $$x_{jk} \text{表示参考图中第} j \text{个特征描述子的第} k \text{个元素}$$

    $$n \text{表示特征向量的维数}$$

  - 两个描述子的相关系数
    $$
    R(i, j) = \frac{\sum_{k=1}^{n} x_{ik} \times x_{jk}}{\sqrt{\sum_{k=1}^{n} x_{ik}^2} \sqrt{\sum_{k=1}^{n} x_{jk}^2}}
    $$
